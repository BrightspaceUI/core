<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
		<title>LocalizeMixin test</title>
		<script src="/node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
		<script src="/node_modules/mocha/mocha.js"></script>
		<script src="/node_modules/chai/chai.js"></script>
		<script src="/node_modules/@polymer/test-fixture/test-fixture.js"></script>
		<script src="/node_modules/wct-mocha/wct-mocha.js"></script>
		<script type="module" src="../demo/localize-test.js"></script>
		<script type="module" src="../demo/localize-test-async.js"></script>
	</head>
	<body>
		<test-fixture id="basic">
			<template>
				<d2l-test-localize></d2l-test-localize>
			</template>
		</test-fixture>
		<test-fixture id="lang-set">
			<template>
				<d2l-test-localize __language="fr"></d2l-test-localize>
			</template>
		</test-fixture>
		<test-fixture id="async">
			<template>
				<d2l-test-localize-async name="Bill"></d2l-test-localize-async>
			</template>
		</test-fixture>
		<test-fixture id="container">
			<template>
				<div></div>
			</template>
		</test-fixture>

		<script type="module">
			import {getDocumentLocaleSettings} from '@brightspace-ui/intl/lib/common.js';
			describe('LocalizeMixin', () => {

				const documentLocaleSettings = getDocumentLocaleSettings();

				afterEach(() => documentLocaleSettings.reset());

				async function fixtureAndAwaitRender(name) {
					const elem = fixture(name);
					await elem.updateComplete;
					return elem;
				}

				['static', 'async'].forEach((type) => {

					const fixtureName = (type === 'static') ? 'basic' : 'async';
					const tagName = (type === 'static') ? 'd2l-test-localize' : 'd2l-test-localize-async';

					describe('localize', () => {
						let elem;
						beforeEach(async() => {
							elem = await fixtureAndAwaitRender(fixtureName);
						});
						it('should localize text using object format', () => {
							const val = elem.localize('hello', {name: 'Bill'});
							expect(val).to.equal('Hello Bill');
						});
						it('should localize text using legacy format', () => {
							const val = elem.localize('hello', 'name', 'Bill');
							expect(val).to.equal('Hello Bill');
						});
						it('should re-localize text when locale changes', (done) => {
							const valInitial = elem.localize('hello', {name: 'Sam'});
							expect(valInitial).to.equal('Hello Sam');
							const myEventListener = () => {
								const val = elem.localize('hello', {name: 'Mary'});
								expect(val).to.equal('Bonjour Mary');
								elem.removeEventListener('d2l-localize-behavior-language-changed', myEventListener);
								done();
							};
							elem.addEventListener('d2l-localize-behavior-language-changed', myEventListener);
							documentLocaleSettings.language = 'fr';
						});
						it('should localize term using plurals', () => {
							const val = elem.localize('plural', {itemCount: 1});
							expect(val).to.equal('You have 1 item.');
						});
					});

					it(`should only render once (${type})`, (done) => {
						const container = fixture('container');
						const elem = document.createElement(tagName);
						let renderCount = 0;
						elem.addEventListener('d2l-test-localize-render', () => {
							renderCount++;
						});
						container.appendChild(elem);
						setTimeout(() => {
							expect(renderCount).to.equal(1);
							done();
						}, 100);
					});

				});

				describe('lang set', () => {
					it('should ignore "__language" attribute and use default', async() => {
						const elem = await fixtureAndAwaitRender('lang-set');
						expect(elem.__language).to.equal('en');
					});
					it('should ignore "__language" attribute and use "lang"', async() => {
						documentLocaleSettings.language = 'de';
						const elem = await fixtureAndAwaitRender('lang-set');
						expect(elem.__language).to.equal('de');
					});
				});

				describe('shouldUpdate tracking', () => {

					it('should pass all changed properties to updated()', (done) => {
						const container = fixture('container');
						const elem = document.createElement('d2l-test-localize-async');
						elem.addEventListener('d2l-test-localize-updated', (e) => {
							const props = e.detail.props;
							expect(props.size).to.equal(2);
							expect(props.has('__language'));
							expect(props.has('__resources'));
							done();
						});
						container.appendChild(elem);
					});

					it('should clear changed properties after language resolution', (done) => {
						const container = fixture('container');
						let first = true;
						const elem = document.createElement('d2l-test-localize-async');
						elem.setAttribute('name', 'Bill');
						elem.addEventListener('d2l-test-localize-updated', (e) => {
							const props = e.detail.props;
							if (first) {
								first = false;
								expect(props.size).to.equal(3);
								return;
							}
							expect(props.size).to.equal(1);
							expect(e.detail.props.has('name'));
							done();
						});
						elem.addEventListener('d2l-test-localize-render', () => {
							elem.setAttribute('name', 'Jim');
						});
						container.appendChild(elem);
					});

				});
			});
		</script>
	</body>
</html>
